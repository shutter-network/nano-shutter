<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shutterized Rock Paper Scissors</title>
  <!-- Include Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .player-section {
      margin-bottom: 30px;
    }
    .data-section {
      word-wrap: break-word;
      background-color: #f8f9fa;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
    }
    .status {
      font-weight: bold;
    }
    .game-result {
      font-size: 1.5em;
      color: #28a745;
      text-align: center;
    }
    .btn-new-game {
      display: block;
      margin: 20px auto;
    }
    .sidebar {
      position: fixed;
      right: 0;
      top: 0;
      width: 25%;
      height: 100%;
      background-color: #f8f9fa;
      padding: 20px;
      border-left: 1px solid #ced4da;
      overflow-y: auto;
    }
    .content {
      margin-right: 26%;
    }
    .panel-heading {
      font-weight: bold;
    }
    .key-text {
      font-family: monospace;
      font-size: 0.9em;
    }
    .truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
      display: inline-block;
      vertical-align: middle;
    }
    .copy-btn {
      margin-left: 5px;
    }
    .tooltip-inner {
      max-width: none;
    }
  </style>
</head>
<body>
  <div class="content">
    <h1>Shutterized Rock Paper Scissors</h1>

    <!-- Player 1 -->
    <div class="player-section">
      <h2>Player 1</h2>
      <div class="form-group">
        <label for="movePlayer1">Choose your move:</label>
        <select id="movePlayer1" class="form-control">
          <option value="Rock">Rock</option>
          <option value="Paper">Paper</option>
          <option value="Scissors">Scissors</option>
        </select>
      </div>
      <button id="submitPlayer1" class="btn btn-primary">Submit Move</button>
    </div>

    <!-- Player 2 -->
    <div class="player-section">
      <h2>Player 2</h2>
      <div class="form-group">
        <label for="movePlayer2">Choose your move:</label>
        <select id="movePlayer2" class="form-control">
          <option value="Rock">Rock</option>
          <option value="Paper">Paper</option>
          <option value="Scissors">Scissors</option>
        </select>
      </div>
      <button id="submitPlayer2" class="btn btn-primary">Submit Move</button>
    </div>

    <!-- Status Message -->
    <h2>Status</h2>
    <p id="status" class="status">Waiting for players to submit their moves...</p>

    <!-- Encrypted Moves -->
    <h2>Encrypted Moves</h2>
    <div id="encryptedMoves"></div>

    <!-- Decrypted Moves -->
    <h2>Decrypted Moves</h2>
    <div id="decryptedMoves" class="data-section"></div>

    <!-- Game Result -->
    <h2>Game Result</h2>
    <p id="gameResult" class="game-result"></p>

    <!-- New Game Button -->
    <button id="newGame" class="btn btn-success btn-new-game">Start New Game</button>
  </div>

  <!-- Sidebar for Decryption Keys -->
  <div class="sidebar">
    <h2>Decryption Keys</h2>
    <div id="decryptionKeys" class="data-section"></div>
  </div>

  <!-- Include Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Include the correct version of libsodium-wrappers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/libsodium-wrappers/0.5.2/sodium.min.js"></script>
  <!-- Include jQuery and Bootstrap JS for tooltip and clipboard functionality -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <!-- Include Clipboard.js for copy-to-clipboard functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>

  <!-- Include NanoShutterCrypto -->
  <script src="nano_shutter_crypto.js"></script>

  <!-- Main Script -->
  <script>
    (async () => {
      // Wait for libsodium to be ready
      await sodium.ready;
      console.log('sodium is ready:', sodium);

      const nanoShutter = new NanoShutterCrypto('http://localhost:5000');
      await nanoShutter.initialize();

      // Fetch eon key to ensure epochDuration is set
      await nanoShutter.fetchEonKey();

      // Store encrypted data for both players
      let encryptedData = {};

      // Store decrypted moves
      let decryptedMoves = {};

      // Store decryption keys
      let decryptionKeys = {};

      // Variable to control the game state
      let gameInProgress = true;

      document.getElementById('submitPlayer1').onclick = async () => {
        if (!gameInProgress) return;

        const move = document.getElementById('movePlayer1').value;

        // Encrypt the move
        const encrypted = await nanoShutter.encryptMessage(move);
        encryptedData.player1 = encrypted;

        // Display encrypted data
        displayEncryptedMoves();

        document.getElementById('status').textContent = 'Player 1 move submitted.';
      };

      document.getElementById('submitPlayer2').onclick = async () => {
        if (!gameInProgress) return;

        const move = document.getElementById('movePlayer2').value;

        // Encrypt the move
        const encrypted = await nanoShutter.encryptMessage(move);
        encryptedData.player2 = encrypted;

        // Display encrypted data
        displayEncryptedMoves();

        document.getElementById('status').textContent = 'Player 2 move submitted.';
      };

      // Function to reset the game
      function resetGame() {
        encryptedData = {};
        decryptedMoves = {};
        decryptionKeys = {};
        gameInProgress = true;
        document.getElementById('status').textContent = 'Waiting for players to submit their moves...';
        document.getElementById('encryptedMoves').innerHTML = '';
        document.getElementById('decryptedMoves').textContent = '';
        document.getElementById('gameResult').textContent = '';
        document.getElementById('decryptionKeys').textContent = '';
      }

      // New Game button handler
      document.getElementById('newGame').onclick = () => {
        resetGame();
      };

      // Function to display encrypted moves nicely
      function displayEncryptedMoves() {
        const container = document.getElementById('encryptedMoves');
        container.innerHTML = '';

        for (let player in encryptedData) {
          const encrypted = encryptedData[player];

          const panel = document.createElement('div');
          panel.className = 'panel panel-default';

          const panelHeading = document.createElement('div');
          panelHeading.className = 'panel-heading';
          panelHeading.textContent = `Encrypted Move - ${player}`;
          panel.appendChild(panelHeading);

          const panelBody = document.createElement('div');
          panelBody.className = 'panel-body';

          const table = document.createElement('table');
          table.className = 'table table-bordered table-condensed';

          for (let key in encrypted) {
            const row = document.createElement('tr');

            const cellKey = document.createElement('td');
            cellKey.style.width = '30%';
            cellKey.textContent = key;
            row.appendChild(cellKey);

            const cellValue = document.createElement('td');
            cellValue.textContent = encrypted[key];
            row.appendChild(cellValue);

            table.appendChild(row);
          }

          panelBody.appendChild(table);
          panel.appendChild(panelBody);

          container.appendChild(panel);
        }
      }

      // Periodically attempt to decrypt moves
      const intervalId = setInterval(async () => {
        try {
          if (!gameInProgress) return;

          // Fetch and display decryption keys
          await fetchDecryptionKeys();

          // Check if both players have submitted their moves
          if (encryptedData.player1 && encryptedData.player2) {
            // Decrypt moves if not already decrypted
            if (!decryptedMoves.player1) {
              decryptedMoves.player1 = await nanoShutter.decryptMessage(encryptedData.player1);
            }
            if (!decryptedMoves.player2) {
              decryptedMoves.player2 = await nanoShutter.decryptMessage(encryptedData.player2);
            }

            // Display decrypted moves
            document.getElementById('decryptedMoves').textContent = JSON.stringify(decryptedMoves, null, 2);

            // Determine the winner
            const result = determineWinner(decryptedMoves.player1, decryptedMoves.player2);

            // Display the result
            document.getElementById('gameResult').textContent = result;

            // Game is over
            gameInProgress = false;

            document.getElementById('status').textContent = 'Game concluded.';
          } else {
            document.getElementById('status').textContent = 'Waiting for both players to submit moves...';
          }
        } catch (e) {
          if (e.message === 'Decryption key not available yet.') {
            console.log('Waiting for decryption key...');
            document.getElementById('status').textContent = 'Waiting for decryption keys...';
          } else {
            console.error('Error during decryption:', e);
            document.getElementById('status').textContent = 'An error occurred during decryption.';
            gameInProgress = false;
          }
        }
      }, 2000); // Try every 2 seconds

      // Function to fetch and display decryption keys
      async function fetchDecryptionKeys() {
        const currentEpoch = nanoShutter.getCurrentEpoch();
        // Iterate over past epochs
        for (let epoch = currentEpoch - 5; epoch <= currentEpoch; epoch++) {
          if (epoch < 0) continue;
          if (decryptionKeys[epoch]) continue; // Skip if already fetched

          try {
            const response = await axios.get(`${nanoShutter.apiUrl}/epoch-public-key`, {
              params: { epoch },
            });
            const epochPublicKey = response.data.epoch_public_key;

            // Store and display the decryption key
            decryptionKeys[epoch] = epochPublicKey;
            displayDecryptionKeys();
          } catch (e) {
            // Handle error if needed
          }
        }
      }

      // Function to display decryption keys
      function displayDecryptionKeys() {
        const container = document.getElementById('decryptionKeys');
        container.innerHTML = '';

        const table = document.createElement('table');
        table.className = 'table table-bordered table-condensed';

        const headerRow = document.createElement('tr');
        const headerEpoch = document.createElement('th');
        headerEpoch.textContent = 'Epoch';
        const headerKey = document.createElement('th');
        headerKey.textContent = 'Epoch Public Key';
        headerRow.appendChild(headerEpoch);
        headerRow.appendChild(headerKey);
        table.appendChild(headerRow);

        // Sort epochs in descending order
        const epochs = Object.keys(decryptionKeys).sort((a, b) => b - a);

        for (let epoch of epochs) {
          const row = document.createElement('tr');

          const cellEpoch = document.createElement('td');
          cellEpoch.style.width = '20%';
          cellEpoch.textContent = epoch;
          row.appendChild(cellEpoch);

          const cellKey = document.createElement('td');
          const key = decryptionKeys[epoch];

          // Truncate the key for display
          const truncatedKey = key.slice(0, 8) + '...' + key.slice(-8);

          const keySpan = document.createElement('span');
          keySpan.className = 'key-text truncate';
          keySpan.textContent = truncatedKey;
          keySpan.setAttribute('title', key); // Full key in tooltip

          // Initialize Bootstrap tooltip
          $(keySpan).tooltip({
            placement: 'bottom',
            html: true,
            title: `<div style="word-break: break-all;">${key}</div>`,
          });

          // Copy to clipboard button
          const copyBtn = document.createElement('button');
          copyBtn.className = 'btn btn-default btn-xs copy-btn';
          copyBtn.textContent = 'Copy';
          copyBtn.setAttribute('data-clipboard-text', key);

          // Initialize Clipboard.js
          const clipboard = new ClipboardJS(copyBtn);

          clipboard.on('success', function(e) {
            // Optionally, show a message or tooltip
            $(copyBtn).tooltip({
              title: 'Copied!',
              trigger: 'manual',
            }).tooltip('show');
            setTimeout(() => {
              $(copyBtn).tooltip('hide');
            }, 1000);
            e.clearSelection();
          });

          const keyContainer = document.createElement('div');
          keyContainer.appendChild(keySpan);
          keyContainer.appendChild(copyBtn);

          cellKey.appendChild(keyContainer);
          row.appendChild(cellKey);

          table.appendChild(row);
        }

        container.appendChild(table);
      }

      // Function to determine the winner
      function determineWinner(move1, move2) {
        if (move1 === move2) {
          return 'It\'s a tie!';
        }

        if (
          (move1 === 'Rock' && move2 === 'Scissors') ||
          (move1 === 'Paper' && move2 === 'Rock') ||
          (move1 === 'Scissors' && move2 === 'Paper')
        ) {
          return 'Player 1 wins!';
        } else {
          return 'Player 2 wins!';
        }
      }
    })();
  </script>
</body>
</html>
